define(["./core","./var/slice","./callbacks"],function(A,B){A.extend({Deferred:function(D){var C=[["resolve","done",A.Callbacks("once memory"),"resolved"],["reject","fail",A.Callbacks("once memory"),"rejected"],["notify","progress",A.Callbacks("memory")]],G="pending",E={state:function(){return G},always:function(){F.done(arguments).fail(arguments);return this},then:function(){var H=arguments;return A.Deferred(function(I){A.each(C,function(J,L){var K=A.isFunction(H[J])&&H[J];F[L[1]](function(){var M=K&&K.apply(this,arguments);if(M&&A.isFunction(M.promise)){M.promise().done(I.resolve).fail(I.reject).progress(I.notify)}else{I[L[0]+"With"](this===E?I.promise():this,K?[M]:arguments)}})});H=null}).promise()},promise:function(H){return H!=null?A.extend(H,E):E}},F={};E.pipe=E.then;A.each(C,function(H,K){var J=K[2],I=K[3];E[K[1]]=J.add;if(I){J.add(function(){G=I},C[H^1][2].disable,C[2][2].lock)}F[K[0]]=function(){F[K[0]+"With"](this===F?E:this,arguments);return this};F[K[0]+"With"]=J.fireWith});E.promise(F);if(D){D.call(F,F)}return F},when:function(K){var G=0,I=B.call(arguments),F=I.length,E=F!==1||(K&&A.isFunction(K.promise))?F:0,C=E===1?K:A.Deferred(),L=function(M,N,O){return function(P){N[M]=this;O[M]=arguments.length>1?B.call(arguments):P;if(O===H){C.notifyWith(N,O)}else{if(!(--E)){C.resolveWith(N,O)}}}},H,D,J;if(F>1){H=new Array(F);D=new Array(F);J=new Array(F);for(;G<F;G++){if(I[G]&&A.isFunction(I[G].promise)){I[G].promise().done(L(G,J,I)).fail(C.reject).progress(L(G,D,H))}else{--E}}}if(!E){C.resolveWith(J,I)}return C.promise()}});return A});