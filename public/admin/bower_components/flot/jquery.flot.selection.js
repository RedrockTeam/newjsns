(function(B){function A(F){var K={first:{x:-1,y:-1},second:{x:-1,y:-1},show:false,active:false};var P={};var C=null;function R(S){if(K.active){I(S);F.getPlaceholder().trigger("plotselecting",[G()])}}function J(S){if(S.which!=1){return}document.body.focus();if(document.onselectstart!==undefined&&P.onselectstart==null){P.onselectstart=document.onselectstart;document.onselectstart=function(){return false}}if(document.ondrag!==undefined&&P.ondrag==null){P.ondrag=document.ondrag;document.ondrag=function(){return false}}H(K.first,S);K.active=true;C=function(T){M(T)};B(document).one("mouseup",C)}function M(S){C=null;if(document.onselectstart!==undefined){document.onselectstart=P.onselectstart}if(document.ondrag!==undefined){document.ondrag=P.ondrag}K.active=false;I(S);if(E()){D()}else{F.getPlaceholder().trigger("plotunselected",[]);F.getPlaceholder().trigger("plotselecting",[null])}return false}function G(){if(!E()){return null}if(!K.show){return null}var S={},U=K.first,T=K.second;B.each(F.getAxes(),function(W,Y){if(Y.used){var V=Y.c2p(U[Y.direction]),X=Y.c2p(T[Y.direction]);S[W]={from:Math.min(V,X),to:Math.max(V,X)}}});return S}function D(){var S=G();F.getPlaceholder().trigger("plotselected",[S]);if(S.xaxis&&S.yaxis){F.getPlaceholder().trigger("selected",[{x1:S.xaxis.from,y1:S.yaxis.from,x2:S.xaxis.to,y2:S.yaxis.to}])}}function Q(S,T,U){return T<S?S:(T>U?U:T)}function H(W,U){var V=F.getOptions();var T=F.getPlaceholder().offset();var S=F.getPlotOffset();W.x=Q(0,U.pageX-T.left-S.left,F.width());W.y=Q(0,U.pageY-T.top-S.top,F.height());if(V.selection.mode=="y"){W.x=W==K.first?0:F.width()}if(V.selection.mode=="x"){W.y=W==K.first?0:F.height()}}function I(S){if(S.pageX==null){return}H(K.second,S);if(E()){K.show=true;F.triggerRedrawOverlay()}else{N(true)}}function N(S){if(K.show){K.show=false;F.triggerRedrawOverlay();if(!S){F.getPlaceholder().trigger("plotunselected",[])}}}function L(U,X){var T,S,a,Z,Y=F.getAxes();for(var W in Y){T=Y[W];if(T.direction==X){Z=X+T.n+"axis";if(!U[Z]&&T.n==1){Z=X+"axis"}if(U[Z]){S=U[Z].from;a=U[Z].to;break}}}if(!U[Z]){T=X=="x"?F.getXAxes()[0]:F.getYAxes()[0];S=U[X+"1"];a=U[X+"2"]}if(S!=null&&a!=null&&S>a){var V=S;S=a;a=V}return{from:S,to:a,axis:T}}function O(T,W){var V,U,S=F.getOptions();if(S.selection.mode=="y"){K.first.x=0;K.second.x=F.width()}else{U=L(T,"x");K.first.x=U.axis.p2c(U.from);K.second.x=U.axis.p2c(U.to)}if(S.selection.mode=="x"){K.first.y=0;K.second.y=F.height()}else{U=L(T,"y");K.first.y=U.axis.p2c(U.from);K.second.y=U.axis.p2c(U.to)}K.show=true;F.triggerRedrawOverlay();if(!W&&E()){D()}}function E(){var S=F.getOptions().selection.minSize;return Math.abs(K.second.x-K.first.x)>=S&&Math.abs(K.second.y-K.first.y)>=S}F.clearSelection=N;F.setSelection=O;F.getSelection=G;F.hooks.bindEvents.push(function(U,T){var S=U.getOptions();if(S.selection.mode!=null){T.mousemove(R);T.mousedown(J)}});F.hooks.drawOverlay.push(function(S,V){if(K.show&&E()){var W=S.getPlotOffset();var X=S.getOptions();V.save();V.translate(W.left,W.top);var Y=B.color.parse(X.selection.color);V.strokeStyle=Y.scale("a",0.8).toString();V.lineWidth=1;V.lineJoin=X.selection.shape;V.fillStyle=Y.scale("a",0.4).toString();var a=Math.min(K.first.x,K.second.x)+0.5,Z=Math.min(K.first.y,K.second.y)+0.5,T=Math.abs(K.second.x-K.first.x)-1,U=Math.abs(K.second.y-K.first.y)-1;V.fillRect(a,Z,T,U);V.strokeRect(a,Z,T,U);V.restore()}});F.hooks.shutdown.push(function(T,S){S.unbind("mousemove",R);S.unbind("mousedown",J);if(C){B(document).unbind("mouseup",C)}})}B.plot.plugins.push({init:A,options:{selection:{mode:null,color:"#e8cfac",shape:"round",minSize:5}},name:"selection",version:"1.1"})})(jQuery);