var tableData=[],editorTable=null,chartsConfig=window.typeConfig,resizeTimer=null,currentChartType=0;window.onload=function(){editorTable=domUtils.findParentByTagName(editor.selection.getRange().startContainer,"table",true);if(!editorTable){document.body.innerHTML="<div class='edui-charts-not-data'>未找到数据</div>";return}initChartsTypeView();renderTable(editorTable);initEvent();initUserConfig(editorTable.getAttribute("data-chart"));$("#scrollBed .view-box:eq("+currentChartType+")").trigger("click");updateViewType(currentChartType);dialog.addListener("resize",function(){if(resizeTimer!=null){window.clearTimeout(resizeTimer)}resizeTimer=window.setTimeout(function(){resizeTimer=null;renderCharts()},500)})};function initChartsTypeView(){var B=[];for(var A=0,C=chartsConfig.length;A<C;A++){B.push('<div class="view-box" data-chart-type="'+A+'"><img width="300" src="images/charts'+A+'.png"></div>')}$("#scrollBed").html(B.join(""))}function renderTable(F){var C=[];for(var A=0,B;B=F.rows[A];A++){tableData[A]=[];C[A]=[];for(var G=0,D;D=B.cells[G];G++){var E=getCellValue(D);if(A>0&&G>0){E=+E}if(A===0||G===0){C[A].push("<th>"+E+"</th>")}else{C[A].push('<td><input type="text" class="data-item" value="'+E+'"></td>')}tableData[A][G]=E}C[A]=C[A].join("")}$("#tableContainer").html('<table id="showTable" border="1"><tbody><tr>'+C.join("</tr><tr>")+"</tr></tbody></table>")}function initUserConfig(A){var B={};if(!A){return}A=A.split(";");$.each(A,function(D,C){C=C.split(":");B[C[0]]=C[1]});setUserConfig(B)}function initEvent(){var A=null,B=chartsConfig.length-1,C=$("#scrollBed .view-box");$(".charts-format").delegate(".format-ctrl","change",function(){renderCharts()});$(".table-view").delegate(".data-item","focus",function(){A=this.value}).delegate(".data-item","blur",function(){if(this.value!==A){renderCharts()}A=null});$("#buttonContainer").delegate("a","click",function(D){D.preventDefault();if(this.getAttribute("data-title")==="prev"){if(currentChartType>0){currentChartType--;updateViewType(currentChartType)}}else{if(currentChartType<B){currentChartType++;updateViewType(currentChartType)}}});$("#scrollBed").delegate(".view-box","click",function(D){var E=$(this).attr("data-chart-type");C.removeClass("selected");$(C[E]).addClass("selected");currentChartType=E|0;if(currentChartType===chartsConfig.length-1){disableNotPieConfig()}else{enableNotPieConfig()}renderCharts()})}function renderCharts(){var A=collectData();$("#chartsContainer").highcharts($.extend({},chartsConfig[currentChartType],{credits:{enabled:false},exporting:{enabled:false},title:{text:A.title,x:-20},subtitle:{text:A.subTitle,x:-20},xAxis:{title:{text:A.xTitle},categories:A.categories},yAxis:{title:{text:A.yTitle},plotLines:[{value:0,width:1,color:"#808080"}]},tooltip:{enabled:true,valueSuffix:A.suffix},legend:{layout:"vertical",align:"right",verticalAlign:"middle",borderWidth:1},series:A.series}))}function updateViewType(A){$("#scrollBed").css("marginLeft",-A*324+"px")}function collectData(){var A=document.forms["data-form"],B=null;if(currentChartType!==chartsConfig.length-1){B=getSeriesAndCategories();$.extend(B,getUserConfig())}else{B=getSeriesForPieChart();B.title=A["title"].value;B.suffix=A["unit"].value}return B}function getUserConfig(){var A=document.forms["data-form"],B={title:A["title"].value,subTitle:A["sub-title"].value,xTitle:A["x-title"].value,yTitle:A["y-title"].value,suffix:A["unit"].value,tableDataFormat:getTableDataFormat(),tip:$("#tipInput").val()};return B}function setUserConfig(B){var A=document.forms["data-form"];B.title&&(A["title"].value=B.title);B.subTitle&&(A["sub-title"].value=B.subTitle);B.xTitle&&(A["x-title"].value=B.xTitle);B.yTitle&&(A["y-title"].value=B.yTitle);B.suffix&&(A["unit"].value=B.suffix);B.dataFormat=="-1"&&(A["charts-format"][1].checked=true);B.tip&&(A["tip"].value=B.tip);currentChartType=B.chartType||0}function getSeriesAndCategories(){var F=document.forms["data-form"],H=[],B=[],E=[],J=getTableData();if(getTableDataFormat()==="-1"){for(var G=0,A=J.length;G<A;G++){for(var D=0,I=J[G].length;D<I;D++){if(!E[D]){E[D]=[]}E[D][G]=J[G][D]}}J=E}B=J[0].slice(1);for(var G=1,C;C=J[G];G++){H.push({name:C[0],data:C.slice(1)})}return{series:H,categories:B}}function getTableDataFormat(){var A=document.forms["data-form"],B=A["charts-format"];return B[0].checked?B[0].value:B[1].value}function disableNotPieConfig(){updateConfigItem("disable")}function enableNotPieConfig(){updateConfigItem("enable")}function updateConfigItem(E){var F=$("#showTable")[0],D=E==="disable"?true:false;for(var A=2,C;C=F.rows[A];A++){for(var G=1,B;B=C.cells[G];G++){$("input",B).attr("disabled",D)}}$("input.not-pie-item").attr("disabled",D);$("#tipInput").attr("disabled",!D)}function getSeriesForPieChart(){var C={type:"pie",name:$("#tipInput").val(),data:[]},F=getTableData();for(var E=1,A=F[0].length;E<A;E++){var B=F[0][E],D=F[1][E];C.data.push([B,D])}return{series:[C]}}function getTableData(){var E=document.getElementById("showTable"),B=E.rows[0].cells.length-1,C=getTableInputValue();for(var A=0,D;D=C[A];A++){tableData[Math.floor(A/B)+1][A%B+1]=C[A]}return tableData}function getTableInputValue(){var E=document.getElementById("showTable"),A=E.getElementsByTagName("input"),C=[];for(var B=0,D;D=A[B];B++){C.push(D.value|0)}return C}function getCellValue(B){var A=utils.trim((B.innerText||B.textContent||""));return A.replace(new RegExp(UE.dom.domUtils.fillChar,"g"),"").replace(/^\s+|\s+$/g,"")}dialog.onok=function(){var A=document.forms["data-form"],B=getUserConfig();B.chartType=currentChartType;syncTableData();editor.execCommand("charts",B)};function syncTableData(){var E=getTableData();for(var A=1,B;B=editorTable.rows[A];A++){for(var D=1,C;C=B.cells[D];D++){C.innerHTML=E[A][D]}}};