function Music(){this.init()}(function(){var A=[],C=[],B=null;Music.prototype={total:70,pageSize:10,dataUrl:"http://tingapi.ting.baidu.com/v1/restserver/ting?method=baidu.ting.search.common",playerUrl:"http://box.baidu.com/widget/flash/bdspacesong.swf",init:function(){var D=this;domUtils.on($G("J_searchName"),"keyup",function(F){var E=window.event||F;if(E.keyCode==13){D.dosearch()}});domUtils.on($G("J_searchBtn"),"click",function(){D.dosearch()})},callback:function(E){var D=this;D.data=E.song_list;setTimeout(function(){$G("J_resultBar").innerHTML=D._renderTemplate(E.song_list)},300)},dosearch:function(){var E=this;B=null;var D=$G("J_searchName").value;if(utils.trim(D)==""){return false}D=encodeURIComponent(D);E._sent(D)},doselect:function(D){var E=this;if(typeof D=="object"){B=D}else{if(typeof D=="number"){B=E.data[D]}}},onpageclick:function(F){var E=this;for(var D=0;D<A.length;D++){$G(A[D]).className="pageoff";$G(C[D]).className="paneloff"}$G("page"+F).className="pageon";$G("panel"+F).className="panelon"},listenTest:function(E){var D=this,G=$G("J_preview"),H=(E.className=="m-try"),F=D._getTryingElem();if(F){F.className="m-try";G.innerHTML=""}if(H){E.className="m-trying";G.innerHTML=D._buildMusicHtml(D._getUrl(true))}},_sent:function(E){var D=this;$G("J_resultBar").innerHTML='<div class="loading"></div>';utils.loadFile(document,{src:D.dataUrl+"&query="+E+"&page_size="+D.total+"&callback=music.callback&.r="+Math.random(),tag:"script",type:"text/javascript",defer:"defer"})},_removeHtml:function(E){var D=/<\s*\/?\s*[^>]*\s*>/gi;return E.replace(D,"")},_getUrl:function(E){var D=this;var F="from=tiebasongwidget&url=&name="+encodeURIComponent(D._removeHtml(B.title))+"&artist="+encodeURIComponent(D._removeHtml(B.author))+"&extra="+encodeURIComponent(D._removeHtml(B.album_title))+"&autoPlay="+E+"&loop=true";return D.playerUrl+"?"+F},_getTryingElem:function(){var E=$G("J_listPanel").getElementsByTagName("span");for(var D=0;D<E.length;D++){if(E[D].className=="m-trying"){return E[D]}}return null},_buildMusicHtml:function(E){var D='<embed class="BDE_try_Music" allowfullscreen="false" pluginspage="http://www.macromedia.com/go/getflashplayer"';D+=' src="'+E+'"';D+=' width="1" height="1" style="position:absolute;left:-2000px;"';D+=' type="application/x-shockwave-flash" wmode="transparent" play="true" loop="false"';D+=' menu="false" allowscriptaccess="never" scale="noborder">';return D},_byteLength:function(D){return D.replace(/[^\u0000-\u007f]/g,"\u0061\u0061").length},_getMaxText:function(D){var E=this;D=E._removeHtml(D);if(E._byteLength(D)>12){return D.substring(0,5)+"..."}if(!D){D="&nbsp;"}return D},_rebuildData:function(I){var G=this,D=[],E=G.pageSize,H;for(var F=0;F<I.length;F++){if((F+E)%E==0){H=[];D.push(H)}H.push(I[F])}return D},_renderTemplate:function(H){var L=this;if(H.length==0){return'<div class="empty">'+lang.emptyTxt+"</div>"}H=L._rebuildData(H);var E=[],F=[],I=[];E.push('<div id="J_listPanel" class="listPanel">');F.push('<div class="page">');for(var K=0,G;G=H[K++];){C.push("panel"+K);A.push("page"+K);if(K==1){E.push('<div id="panel'+K+'" class="panelon">');if(H.length!=1){I.push('<div id="page'+K+'" onclick="music.onpageclick('+K+')" class="pageon">'+(K)+"</div>")}}else{E.push('<div id="panel'+K+'" class="paneloff">');I.push('<div id="page'+K+'" onclick="music.onpageclick('+K+')" class="pageoff">'+(K)+"</div>")}E.push('<div class="m-box">');E.push('<div class="m-h"><span class="m-t">'+lang.chapter+'</span><span class="m-s">'+lang.singer+'</span><span class="m-z">'+lang.special+'</span><span class="m-try-t">'+lang.listenTest+"</span></div>");for(var J=0,D;D=G[J++];){E.push('<label for="radio-'+K+"-"+J+'" class="m-m">');E.push('<input type="radio" id="radio-'+K+"-"+J+'" name="musicId" class="m-l" onclick="music.doselect('+(L.pageSize*(K-1)+(J-1))+')"/>');E.push('<span class="m-t">'+L._getMaxText(D.title)+"</span>");E.push('<span class="m-s">'+L._getMaxText(D.author)+"</span>");E.push('<span class="m-z">'+L._getMaxText(D.album_title)+"</span>");E.push('<span class="m-try" onclick="music.doselect('+(L.pageSize*(K-1)+(J-1))+');music.listenTest(this)"></span>');E.push("</label>")}E.push("</div>");E.push("</div>")}I.reverse();F.push(I.join(""));E.push("</div>");F.push("</div>");return E.join("")+F.join("")},exec:function(){var D=this;if(B==null){return}$G("J_preview").innerHTML="";editor.execCommand("music",{url:D._getUrl(false),width:400,height:95})}}})();