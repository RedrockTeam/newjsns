(function(A){A(function(){var W=A("#uploader"),G=A('<ul class="filelist"></ul>').appendTo(W.find(".queueList")),Q=W.find(".statusBar"),C=Q.find(".info"),S=W.find(".uploadBtn"),I=W.find(".placeholder"),N=Q.find(".progress").hide(),P=0,T=0,R=window.devicePixelRatio||1,J=110*R,U=110*R,H="pedding",F={},K=(function(){var Z=new Image();var Y=true;Z.onload=Z.onerror=function(){if(this.width!=1||this.height!=1){Y=false}};Z.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///ywAAAAAAQABAAACAUwAOw==";return Y})(),B=(function(){var a;try{a=navigator.plugins["Shockwave Flash"];a=a.description}catch(Z){try{a=new ActiveXObject("ShockwaveFlash.ShockwaveFlash").GetVariable("$version")}catch(Y){a="0.0"}}a=a.match(/\d+/g);return parseFloat(a[0]+"."+a[1],10)})(),D=(function(){var Z=document.createElement("p").style,Y="transition" in Z||"WebkitTransition" in Z||"MozTransition" in Z||"msTransition" in Z||"OTransition" in Z;Z=null;return Y})(),M;if(!WebUploader.Uploader.support("flash")&&WebUploader.browser.ie){if(B){(function(a){window["expressinstallcallback"]=function(b){switch(b){case"Download.Cancelled":alert("您取消了更新！");break;case"Download.Failed":alert("安装失败");break;default:alert("安装已成功，请刷新！");break}delete window["expressinstallcallback"]};var Z="./expressInstall.swf";var Y='<object type="application/x-shockwave-flash" data="'+Z+'" ';if(WebUploader.browser.ie){Y+='classid="clsid:d27cdb6e-ae6d-11cf-96b8-444553540000" '}Y+='width="100%" height="100%" style="outline:0"><param name="movie" value="'+Z+'" /><param name="wmode" value="transparent" /><param name="allowscriptaccess" value="always" /></object>';a.html(Y)})(W)}else{W.html('<a href="http://www.adobe.com/go/getflashplayer" target="_blank" border="0"><img alt="get flash player" src="http://www.adobe.com/macromedia/style_guide/images/160x41_Get_Flash_Player.jpg" /></a>')}return}else{if(!WebUploader.Uploader.support()){alert("Web Uploader 不支持您的浏览器！");return}}M=WebUploader.create({pick:{id:"#filePicker",label:"点击选择图片"},formData:{uid:123},dnd:"#dndArea",paste:"#uploader",swf:"../../dist/Uploader.swf",chunked:false,chunkSize:512*1024,server:"../../server/fileupload.php",disableGlobalDnd:true,fileNumLimit:300,fileSizeLimit:200*1024*1024,fileSingleSizeLimit:50*1024*1024});M.on("dndAccept",function(a){var c=false,Z=a.length,Y=0,b="text/plain;application/javascript ";for(;Y<Z;Y++){if(~b.indexOf(a[Y].type)){c=true;break}}return !c});M.on("dialogOpen",function(){console.log("here")});M.addButton({id:"#filePicker2",label:"继续添加"});M.on("ready",function(){window.uploader=M});function L(d){var e=A('<li id="'+d.id+'"><p class="title">'+d.name+'</p><p class="imgWrap"></p><p class="progress"><span></span></p></li>'),Y=A('<div class="file-panel"><span class="cancel">删除</span><span class="rotateRight">向右旋转</span><span class="rotateLeft">向左旋转</span></div>').appendTo(e),a=e.find("p.progress span"),Z=e.find("p.imgWrap"),c=A('<p class="error"></p>'),b=function(f){switch(f){case"exceed_size":text="文件大小超出";break;case"interrupt":text="上传暂停";break;default:text="上传失败，请重试";break}c.text(text).appendTo(e)};if(d.getStatus()==="invalid"){b(d.statusText)}else{Z.text("预览中");M.makeThumb(d,function(g,f){var h;if(g){Z.text("不能预览");return}if(K){h=A('<img src="'+f+'">');Z.empty().append(h)}else{A.ajax("../../server/preview.php",{method:"POST",data:f,dataType:"json"}).done(function(i){if(i.result){h=A('<img src="'+i.result+'">');Z.empty().append(h)}else{Z.text("预览出错")}})}},J,U);F[d.id]=[d.size,0];d.rotation=0}d.on("statuschange",function(f,g){if(g==="progress"){a.hide().width(0)}else{if(g==="queued"){e.off("mouseenter mouseleave");Y.remove()}}if(f==="error"||f==="invalid"){console.log(d.statusText);b(d.statusText);F[d.id][1]=1}else{if(f==="interrupt"){b("interrupt")}else{if(f==="queued"){F[d.id][1]=0}else{if(f==="progress"){c.remove();a.css("display","block")}else{if(f==="complete"){e.append('<span class="success"></span>')}}}}}e.removeClass("state-"+g).addClass("state-"+f)});e.on("mouseenter",function(){Y.stop().animate({height:30})});e.on("mouseleave",function(){Y.stop().animate({height:0})});Y.on("click","span",function(){var f=A(this).index(),g;switch(f){case 0:M.removeFile(d);return;case 1:d.rotation+=90;break;case 2:d.rotation-=90;break}if(D){g="rotate("+d.rotation+"deg)";Z.css({"-webkit-transform":g,"-mos-transform":g,"-o-transform":g,"transform":g})}else{Z.css("filter","progid:DXImageTransform.Microsoft.BasicImage(rotation="+(~~((d.rotation/90)%4+4)%4)+")")}});e.appendTo(G)}function V(Y){var Z=A("#"+Y.id);delete F[Y.id];O();Z.off().find(".file-panel").off().end().remove()}function O(){var b=0,Z=0,a=N.children(),Y;A.each(F,function(d,c){Z+=c[0];b+=c[0]*c[1]});Y=Z?b/Z:0;a.eq(0).text(Math.round(Y*100)+"%");a.eq(1).css("width",Math.round(Y*100)+"%");X()}function X(){var Z="",Y;if(H==="ready"){Z="选中"+P+"张图片，共"+WebUploader.formatSize(T)+"。"}else{if(H==="confirm"){Y=M.getStats();if(Y.uploadFailNum){Z="已成功上传"+Y.successNum+"张照片至XX相册，"+Y.uploadFailNum+'张照片上传失败，<a class="retry" href="#">重新上传</a>失败图片或<a class="ignore" href="#">忽略</a>'}}else{Y=M.getStats();Z="共"+P+"张（"+WebUploader.formatSize(T)+"），已上传"+Y.successNum+"张";if(Y.uploadFailNum){Z+="，失败"+Y.uploadFailNum+"张"}}}C.html(Z)}function E(Z){var a,Y;if(Z===H){return}S.removeClass("state-"+H);S.addClass("state-"+Z);H=Z;switch(H){case"pedding":I.removeClass("element-invisible");G.hide();Q.addClass("element-invisible");M.refresh();break;case"ready":I.addClass("element-invisible");A("#filePicker2").removeClass("element-invisible");G.show();Q.removeClass("element-invisible");M.refresh();break;case"uploading":A("#filePicker2").addClass("element-invisible");N.show();S.text("暂停上传");break;case"paused":N.show();S.text("继续上传");break;case"confirm":N.hide();A("#filePicker2").removeClass("element-invisible");S.text("开始上传");Y=M.getStats();if(Y.successNum&&!Y.uploadFailNum){E("finish");return}break;case"finish":Y=M.getStats();if(Y.successNum){alert("上传成功")}else{H="done";location.reload()}break}X()}M.onUploadProgress=function(a,Z){var b=A("#"+a.id),Y=b.find(".progress span");Y.css("width",Z*100+"%");F[a.id][1]=Z;O()};M.onFileQueued=function(Y){P++;T+=Y.size;if(P===1){I.addClass("element-invisible");Q.show()}L(Y);E("ready");O()};M.onFileDequeued=function(Y){P--;T-=Y.size;if(!P){E("pedding")}V(Y);O()};M.on("all",function(Y){var Z;switch(Y){case"uploadFinished":E("confirm");break;case"startUpload":E("uploading");break;case"stopUpload":E("paused");break}});M.onError=function(Y){alert("Eroor: "+Y)};S.on("click",function(){if(A(this).hasClass("disabled")){return false}if(H==="ready"){M.upload()}else{if(H==="paused"){M.upload()}else{if(H==="uploading"){M.stop()}}}});C.on("click",".retry",function(){M.retry()});C.on("click",".ignore",function(){alert("todo")});S.addClass("state-"+H);O()})})(jQuery);