!function(I,N,L){function J(F,E,B){var G=0,C=0,D=null,A=null;for(done=function(){G===F.length&&(clearInterval(D),B&&B())};C<F.length;C++){A=F[C],A.height=parseInt(A.height),A.width=parseInt(A.width),A.height>=0&&A.width>=0?++G:!function(P){H(P[E],function(R,O){P.width=R,P.height=O,++G},null,function(){P.width=208,P.height=240,P.imgSrc="images/default.jpg",++G})}(A)}D=setInterval(done,40)}function M(B,A){clearTimeout(B.tid),A=A||null,B.tid=setTimeout(function(){B.call(A)},100)}function K(A){var B,F,D,C=A.slice(),G=[],E=A.length;for(B=0;E>B;B++){G[B]=B}for(B=0;E>B;B++){for(F=B;E>F;F++){C[F]<C[B]&&(D=C[B],C[B]=C[F],C[F]=D,D=G[B],G[B]=G[F],G[F]=D)}}return A.minHeight=A[G[0]],A.maxHeight=A[G[G.length-1]],G}I.fn.waterfall=function(F){function u(){n||r||G.minHeight+C<I(N).height()+I(N).scrollTop()&&(t.length>0?E():"infinite"===k.ajaxTimes||o<k.ajaxTimes?(i("loading"),k.params.ajax=++o,s(function(O){try{"string"==typeof O&&(O=I.parseJSON(O)),I.isEmptyObject(O)||"string"==typeof O?i("finish"):(t=t.concat(O.data).reverse(),E())}catch(P){i("error")}},function(){i("error")})):i("finish"))}function E(){var O,P,S,Q="number"==typeof k.perNum?k.perNum:k.colNum,R=null;j.height();J(t,k.imgUrlName,function(){for(;Q-->0&&(R=t.pop());){g=K(G)[0],B=g*(k.colWidth+k.marginLeft),h=G[g]+k.marginTop,S=v(R),O=I("<div>").addClass(k.itemClass).html(S).css({left:B,top:h}).appendTo(j),P=O.find("."+k.imgClass),P.width("200px"),P.height(P.width()*(R.height/R.width)),k.isAnimation&&O.css({opacity:0}).animate({opacity:1},800),G[g]=h+O.outerHeight(),G[g]>G.maxHeight&&(G.maxHeight=G[g]),j.height(G.maxHeight)}r=!1,f.hide(),u()})}function l(){var R=0,O=0,Q=0,P=0;if(R=Math.floor((m.width()+k.marginLeft)/(k.colWidth+k.marginLeft)),R>0&&R!==k.colNum){for(k.colNum=R,j.width((k.colWidth+k.marginLeft)*k.colNum-k.marginLeft),O=0;O<k.colNum;O++){G[O]=0}G.length=k.colNum,q=j.children(".wf_item"),q.each(function(){g=K(G)[0],h=G[g]+k.marginTop,B=g*(k.colWidth+k.marginLeft),k.isAnimation&&(P=300),I(this).width(k.colWidth).animate({left:B,top:h},P),G[g]=h+I(this).outerHeight()}),K(G),j.height(G.maxHeight),u()}Q=j.offset().left+(j.width()+m.width())/2-p.width(),A(p[0],{left:Q,bottom:0})}function i(O){switch(O){case"loading":r=!0,f.html("").addClass("wf_loading").show();break;case"error":f.removeClass("wf_loading").show().html("数据格式错误，请返回标准的Json数据或Json格式字符串！"),n=!0;break;case"finish":f.removeClass("wf_loading").show().html("已加载完毕，没有更多了！"),n=!0}}var m,j,q,f,p,k=I.extend({},I.fn.waterfall.defaults,F),D=!-[1]&&!N.XMLHttpRequest,o=0,r=!1,n=!1,G=[],g=0,t=[],C=0,h=0,B=0,s=I.isFunction(k.ajaxFunc)?k.ajaxFunc:function(P,O){I.ajax({type:"GET",url:k.url,cache:!1,data:k.params,dataType:"json",timeout:60000,success:P,error:O})},v=I.isFunction(k.createHtml)?k.createHtml:function(O){return'<div class="wf_item_inner"><a href="'+O.href+'" class="thumb" target="_blank"><img class="'+k.imgClass+'"  src="'+O.imgSrc+'" /></a><h3 class="title"><a href="'+O.href+'" target="_blank">'+O.title+'</a></h3><p class="desc">'+O.describe+"</p></div>"},A=function(){var R=L.getElementsByTagName("html")[0],P=L.documentElement,O=L.body,Q=P||O;return D&&"fixed"!==O.currentStyle.backgroundAttachment&&(R.style.backgroundImage="url(about:blank)",R.style.backgroundAttachment="fixed"),D?function(S,V){var T=S.style,U="(document.documentElement || document.body)";"number"!=typeof V.left&&(V.left=Q.clientWidth-V.right-S.offsetWidth),"number"!=typeof V.top&&(V.top=Q.clientHeight-V.bottom-S.offsetHeight),S.style.position="absolute",T.removeExpression("left"),T.removeExpression("top"),T.setExpression("left","eval("+U+".scrollLeft + "+V.left+') + "px"'),T.setExpression("top","eval("+U+".scrollTop + "+V.top+') + "px"')}:function(U,T){var S=U.style;S.position="fixed","number"==typeof T.left?S.left=T.left+"px":(S.left="auto",S.right=T.right+"px"),"number"==typeof T.top?S.top=T.top+"px":(S.top="auto",S.bottom=T.bottom+"px")}}();return this.each(function(){return I(this).data("_wf_is_done_")?!0:(m=I(this).addClass("waterfall").data("_wf_is_done_",!0),C=m.offset().top,j=m.children(".wf_col"),0===j.length&&(j=I("<div>").addClass("wf_col").appendTo(m)),f=I("<div>").addClass("wf_result").appendTo(m),p=I("<a></a>").attr("id","backTop").attr("title","返回顶部").appendTo(L.body),p.css("opacity",0).bind("click",function(){I("body,html").stop(!0).animate({scrollTop:C},500)}),I(L.body).css("overflow","scroll"),l(),I(L.body).css("overflow","auto"),u(),void I(N).bind("scroll",function(){I(N).scrollTop()>C?p.stop(!0).animate({opacity:1},500):p.stop(!0).animate({opacity:0},500),u()}).bind("resize",function(){M(l)}))})},I.fn.waterfall.defaults={itemClass:"wf_item",imgClass:"thumb_img",colWidth:235,marginLeft:15,marginTop:15,perNum:"auto",isAnimation:!0,ajaxTimes:"infinite",imgUrlName:"img_src",params:{},url:"",ajaxFunc:null,createHtml:null};var H=function(){var D=[],A=null,B=function(){for(var E=0;E<D.length;E++){D[E].end?D.splice(E--,1):D[E]()}!D.length&&C()},C=function(){clearInterval(A),A=null};return function(X,a,G,E){var Z,W,V,b,Y,F=new Image();return X?(F.src=X,F.complete?(a(F.width,F.height),void (G&&G(F.width,F.height))):(W=F.width,V=F.height,Z=function(){b=F.width,Y=F.height,(b!==W||Y!==V||b*Y>1024)&&(a(b,Y),Z.end=!0)},Z(),F.onerror=function(){alert("图片加载错误"),E&&E(),Z.end=!0,F=F.onload=F.onerror=null},F.onload=function(){G&&G(F.width,F.height),!Z.end&&Z(),F=F.onload=F.onerror=null},void (Z.end||(D.push(Z),null===A&&(A=setInterval(B,40)))))):void (E&&E())}}()}(jQuery,window,document);