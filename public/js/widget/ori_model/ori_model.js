define(["jquery","underscore","port"],function(C,B,A){C(function(){function S(){R={father_id:0,to:G.attr("data-uid"),reply:[],username:E},F(A.comment,R,function(U){R.uid=C(".js-user_own_info").attr("data-user_id"),R.id=U.id;var V=B.template(N.html())({data:[R]});K.before(V),K.fadeOut(),alert("评论成功!!!!"),R=null,L.val("").attr("placeholder","评论："),T=0})}function M(){F(A.comment,R,function(){var U='<span class="from u-name">'+R.fn+'</span>回复<span class="to u-name">'+R.tn+'</span> <span class="reply_cotent u-content">'+R.content+"</span><br/>";J.siblings(".js-reply_lists").append(U),alert("回复成功!!!!!"),R=null,L.val("").attr("placeholder","评论："),T=0})}function I(){C.ajax({url:A.collect,data:{type_id:D,passage_id:H},method:"POST",success:function(U){var V;(U=P(U))&&U.success&&(V=U.info?parseInt(C(".js-love_num").text())+1:parseInt(C(".js-love_num").text())-1,console.log(V),C(".js-love_num").text(V),G.attr("data-love_num",V))},error:function(U){alert("服务器数据出错!!!!"),alert(U.responseText)}})}function Q(U){C.ajax({url:A.get_comments,type:"POST",data:U,success:function(V){if(V=P(V)){if(V.success){V.cz.forEach(function(Y,X){Y.reply=V.lzl[X]});var W=B.template(N.html())({data:V.cz});console.log(V.cz),C(".js-w_comments").html(W),K.fadeOut()}else{alert("数据获取失败，请稍后再试!!!"),V.err&&alert(V.err)}}},error:function(V){alert("服务器数据有问题!!!!情况未明"),alert(V.responseText)}})}function P(V){if("object"!=typeof V){try{V=JSON.parse(V)}catch(U){return alert("服务其数据出错!!!!"),alert(U),!1}}return V}function F(V,W,U){W=C.extend(W,{type_id:D,passage_id:H,content:C(".js-data_input").val()}),C.ajax({url:V,type:"POST",data:W,success:function(X){(X=P(X))&&(X.success?U(X):(alert("操作失败!!!!"),X.err&&alert(X.err)))},error:function(X){alert("服务器数据出错!!!!!"),alert(X.responseText)}})}function O(){var V=C(this),U=V.find(".js-bac_url").attr("data-url");C(".js-model_show").attr("src",U),console.log(U)}var J,G,N=C("#temp_comment"),K=C(".js-loading"),L=C(".js-data_input"),T=0,E=C(".js-user_name").text(),R=null,D=0,H=0;C(".js-open_model").on("click",function(V){var U=C(this);U.data("pIndex",0),G=C(this),D=U.attr("data-type_id"),H=U.attr("data-passage_id"),V.preventDefault(),C(".js-control_model").show(),C(".js-wrap").show(),C(".js-model").show(),C(".js-more_link").attr("href",U.attr("data-url")),Q({type_id:D,passage_id:H,page:0}),O.call(U),C(".js-love_num").text(U.attr("data-love_num")),C(".js-introduce").text(U.attr("data-intro")),C(".js-author").text(U.attr("data-author"))}),C(".js-control_model, .js-wrap").on("click",function(){C(".js-control_model").hide(),C(".js-wrap").fadeOut()}),C(".js-model").on("click",function(U){U.stopPropagation()}),C(".js-collect").on("click",I),C(".js-comment").on("click",function(){0===T?S():M()}),C(".js-prev").on("click",function(){var U=parseInt(G.data("pIndex"))-1;console.log(U),U>=0&&Q({type_id:D,passage_id:H,page:U}),G.data("pIndex",0>U?0:U)}),C(".js-next").on("click",function(){var U=parseInt(G.data("pIndex"))+1;console.log(U),G.data("pIndex",U),Q({type_id:D,passage_id:H,page:U})}),C(".js-model").on("click",".js-reply",function(){J=C(this);var V=C(this),U=V.parents(".js-father");R={to:U.attr("data-fi"),tn:U.attr("data-fn"),father_id:U.attr("data-ffi"),fn:E},console.log(R),T=1,L.select().attr("placeholder","回复"+R.tn+":"),window.scroll(0,L.offset().top)})})});