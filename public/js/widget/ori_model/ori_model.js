define(["jquery","underscore","port"],function(a,b,c){a(function(){function d(){r={father_id:0,to:l.attr("data-uid"),reply:[],username:q},i(c.comment,r,function(c){r.uid=a(".js-user_own_info").attr("data-user_id"),r.id=c.id;var d=b.template(m.html())({data:[r]});n.before(d),n.fadeOut(),alert("评论成功!!!!"),r=null,o.val("").attr("placeholder","评论："),p=0})}function e(){i(c.comment,r,function(){var a='<span class="from u-name">'+r.fn+'</span>回复<span class="to u-name">'+r.tn+'</span> <span class="reply_cotent u-content">'+r.content+"</span><br/>";k.siblings(".js-reply_lists").append(a),alert("回复成功!!!!!"),r=null,o.val("").attr("placeholder","评论："),p=0})}function f(){a.ajax({url:c.collect,data:{type_id:s,passage_id:t},method:"POST",success:function(b){var c;(b=h(b))&&b.success&&(c=b.info?parseInt(a(".js-love_num").text())+1:parseInt(a(".js-love_num").text())-1,console.log(c),a(".js-love_num").text(c),l.attr("data-love_num",c))},error:function(a){alert("服务器数据出错!!!!"),alert(a.responseText)}})}function g(d){a.ajax({url:c.get_comments,type:"POST",data:d,success:function(c){if(c=h(c))if(c.success){c.cz.forEach(function(a,b){a.reply=c.lzl[b]});var d=b.template(m.html())({data:c.cz});console.log(c.cz),a(".js-w_comments").html(d),n.fadeOut()}else alert("数据获取失败，请稍后再试!!!"),c.err&&alert(c.err)},error:function(a){alert("服务器数据有问题!!!!情况未明"),alert(a.responseText)}})}function h(a){if("object"!=typeof a)try{a=JSON.parse(a)}catch(b){return alert("服务其数据出错!!!!"),alert(b),!1}return a}function i(b,c,d){c=a.extend(c,{type_id:s,passage_id:t,content:a(".js-data_input").val()}),a.ajax({url:b,type:"POST",data:c,success:function(a){(a=h(a))&&(a.success?d(a):(alert("操作失败!!!!"),a.err&&alert(a.err)))},error:function(a){alert("服务器数据出错!!!!!"),alert(a.responseText)}})}function j(){var b=a(this),c=b.find(".js-bac_url").attr("data-url");a(".js-model_show").attr("src",c),console.log(c)}var k,l,m=a("#temp_comment"),n=a(".js-loading"),o=a(".js-data_input"),p=0,q=a(".js-user_name").text(),r=null,s=0,t=0;a(".js-open_model").on("click",function(b){var c=a(this);c.data("pIndex",0),l=a(this),s=c.attr("data-type_id"),t=c.attr("data-passage_id"),b.preventDefault(),a(".js-control_model").show(),a(".js-wrap").show(),a(".js-model").show(),a(".js-more_link").attr("href",c.attr("data-url")),g({type_id:s,passage_id:t,page:0}),j.call(c),a(".js-love_num").text(c.attr("data-love_num")),a(".js-introduce").text(c.attr("data-intro")),a(".js-author").text(c.attr("data-author"))}),a(".js-control_model, .js-wrap").on("click",function(){a(".js-control_model").hide(),a(".js-wrap").fadeOut()}),a(".js-model").on("click",function(a){a.stopPropagation()}),a(".js-collect").on("click",f),a(".js-comment").on("click",function(){0===p?d():e()}),a(".js-prev").on("click",function(){var a=parseInt(l.data("pIndex"))-1;console.log(a),a>=0&&g({type_id:s,passage_id:t,page:a}),l.data("pIndex",0>a?0:a)}),a(".js-next").on("click",function(){var a=parseInt(l.data("pIndex"))+1;console.log(a),l.data("pIndex",a),g({type_id:s,passage_id:t,page:a})}),a(".js-model").on("click",".js-reply",function(){k=a(this);var b=a(this),c=b.parents(".js-father");r={to:c.attr("data-fi"),tn:c.attr("data-fn"),father_id:c.attr("data-ffi"),fn:q},console.log(r),p=1,o.select().attr("placeholder","回复"+r.tn+":"),window.scroll(0,o.offset().top)})})});