define(["jquery","underscore","port"],function(N,E,A){function H(T){var S=N(T.target);K=N("body").scrollTop(),R(),C=2,J=S.parents(".js-reply_father"),D=N(".js-reply_item").eq(0).clone(!0),M={to:S.siblings(".js-user_info").find(".js-user_from").attr("data-value"),to_name:S.siblings(".js-user_info").find(".js-user_from").text(),father_id:S.parents(".js-reply_father").attr("data-value")},N(".js-form_editor").find(".js-content").css("text-indent",0).attr("placeholder","回复"+M.to_name+":")}function O(T){var S=N(T.target);K=N("body").scrollTop(),J=S.parents(".js-reply_father"),D=N(".js-reply_item").eq(0).clone(!0),C=1,R(),M={to:S.parents(".js-user_action").siblings(".js-father_user").attr("data-value"),to_name:S.parents(".js-user_action").siblings(".js-father_user").text(),father_id:S.parents(".js-reply_father").attr("data-value")},console.log(S.parents(".js-user_action").siblings(".js-father_user")),N(".js-form_editor").find(".js-content").css("text-indent",0).attr("placeholder","回复"+M.to_name+":")}function L(T){T.preventDefault();var S=N(this);M=N.extend({from:N(".js-user_own_info").attr("data-user_id"),from_name:N(".js-user_own_info").find(".js-user_name").text(),to_name:N(".js-content_title").text(),to:N(".js-content_info").attr("data-value"),type_id:N(".js-passage_info").attr("data-type_id"),passage_id:N(".js-passage_info").attr("data-passage_id"),father_id:0},M),B.call(S)&&P()}function B(){var S=this,T=S.find(".js-content").val();return T.length>300||T.length<1?(alert("您输入的字数不正确!!!"),!1):(M.content=T,!0)}function P(){console.log(M),console.log(A.comment),N.ajax({url:A.comment,method:"POST",dataType:"json",data:M,success:function(S){if("object"!=typeof S){try{S=JSON.parse(S)}catch(T){alert("数据错误!!!!")}}S.success?Q(S):G(S)},error:function(S){alert("http状态错误"+S.status)}})}function Q(){I(),M=null,C=0,N(".js-form_editor").find(".js-content").val("").css("text-indent","2rem").attr("placeholder","这里发表评论(最大字数为300字)"),N("body").scrollTop(K),alert("发表评论成功!!!")}function I(){if(0===C){window.location.reload()}else{var S=E.template(N("#temp_reply").html())({data:M});J.find(".js-user_action").before(S)}}function G(S){alert(S.err?S.err:"评论失败")}function R(){N("html, body").css({scrollTop:F.offset().top}).find('input[type="text"]').focus()}var F=N(".js-form_editor"),J=null,D=null,M={},K=0,C=0;N(document.body).on("click",".js-reply_btn",H),N(document.body).on("click",".js-comment_btn",O),F.on("submit",L)});